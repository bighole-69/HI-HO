import pandas as pd
import plotly.express as px
import streamlit as st
import math

st.set_page_config(page_title="êµ­ê°€ë³„ MBTI ì‹œê°í™”", layout="wide")

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
@st.cache_data
def load_data():
    return pd.read_csv("countriesMBTI_16types.csv")

df = load_data()

st.title("ğŸŒ êµ­ê°€ë³„ MBTI ë¹„ìœ¨ ì‹œê°í™” ëŒ€ì‹œë³´ë“œ")
st.write("êµ­ê°€ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ êµ­ê°€ì˜ MBTI ìœ í˜• ë¶„í¬ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

# -----------------------------------
# (1) êµ­ê°€ ì„ íƒ â†’ MBTI ë¶„í¬ ê·¸ë˜í”„
# -----------------------------------

country = st.selectbox("êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”:", df["Country"].unique())

selected = df[df["Country"] == country].iloc[0].drop("Country")
selected = selected.sort_values(ascending=False)

# ë¹¨ê°„ìƒ‰ ê³„ì—´ ê·¸ë¼ë°ì´ì…˜
colors = px.colors.sequential.Reds[len(selected)]
colors = colors[::-1]  # ìˆœì„œ ë°˜ì „

fig1 = px.bar(
    x=selected.index,
    y=selected.values,
    color=selected.index,
    color_discrete_sequence=colors,
    labels={"x": "MBTI ìœ í˜•", "y": "ë¹„ìœ¨"},
    title=f"ğŸ‡¨ğŸ‡´ {country} ì˜ MBTI ë¹„ìœ¨ (ë†’ì€ ìˆœ)"
)
fig1.update_layout(showlegend=False)

st.plotly_chart(fig1, use_container_width=True)

# -----------------------------------
# (2) MBTI ìœ í˜• ì„ íƒ â†’ ë†’ì€ êµ­ê°€ìˆœ ê·¸ë˜í”„
# -----------------------------------
st.markdown("---")
st.subheader("ğŸ” MBTI ìœ í˜•ë³„ë¡œ ì–´ë–¤ ë‚˜ë¼ê°€ ê°€ì¥ ë§ì€ì§€ ë³´ê¸°")

mbti_types = list(df.columns)
mbti_types.remove("Country")

mbti_choice = st.selectbox("MBTI ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”:", mbti_types)

ranking = df[["Country", mbti_choice]].sort_values(by=mbti_choice, ascending=False)

# ìƒ‰ìƒ íŒ¨í„´ (íŒŒë‘ â†’ ë…¸ë‘ â†’ ë¹¨ê°• ë°˜ë³µ)
base_colors = ["blue", "yellow", "red"]
color_cycle = (base_colors * math.ceil(len(ranking) / 3))[:len(ranking)]

fig2 = px.bar(
    ranking,
    x="Country",
    y=mbti_choice,
    color="Country",
    color_discrete_sequence=color_cycle,
    labels={"Country": "êµ­ê°€", mbti_choice: "ë¹„ìœ¨"},
    title=f"ğŸ“ˆ {mbti_choice} ìœ í˜•ì´ ë§ì€ êµ­ê°€ ìˆœìœ„"
)

fig2.update_layout(showlegend=False)
st.plotly_chart(fig2, use_container_width=True)
